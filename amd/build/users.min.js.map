{"version":3,"file":"users.min.js","sources":["../src/users.js"],"sourcesContent":["import $ from 'jquery';\r\nimport Templates from \"core/templates\";\r\nimport ModalDefault from 'core/modal';\r\nimport ModalEvents from 'core/modal_events';\r\nimport {get_string as getString} from 'core/str';\r\nimport ModalSaveCancel from 'core/modal_save_cancel';\r\nimport Utils from 'local_certificate_management/utils';\r\nimport Repository from 'local_certificate_management/repository';\r\n\r\n\r\nconst getParams = async root => {\r\n    return {\r\n        courseId: Number(root.attr('data-courseid')),\r\n        limit: Number(root.attr('data-limit')),\r\n        page: Number(root.attr('data-page')),\r\n        search: root.find('#search-param').val() || '',\r\n        sort: root.find('#order-param').val() || '',\r\n    };\r\n}\r\n\r\nconst usersComponents = {\r\n    notFound: 'local_certificate_management/components/users/table-row-not-found',\r\n    empty: 'local_certificate_management/components/users/table-row-empty',\r\n    content: 'local_certificate_management/components/users/table-row'\r\n}\r\n\r\nconst loadUsers = async (root, seeMore = false) => {\r\n    try {\r\n        const params = await getParams(root);\r\n        const data = await Repository.retrieveUsers(params);\r\n\r\n        let templateToLoad = usersComponents.content;\r\n\r\n        if (!seeMore && !data.users.length && !params.search) {\r\n            templateToLoad = usersComponents.empty;\r\n        }\r\n\r\n        if (!seeMore && !data.users.length && params.search) {\r\n            Utils.disableButton(root);\r\n            templateToLoad = usersComponents.notFound;\r\n        }\r\n\r\n        if (!seeMore) {\r\n            root.find('.users-content').empty();\r\n            root.find('.total-users').text(0);\r\n        }\r\n\r\n        const html = await Templates.render(templateToLoad, {users: data.users});\r\n\r\n        root.find('.total-users').text(data.total)\r\n\r\n        root.find('.users-content').append(html);\r\n\r\n        const coursesLength = root.find('.users-item').length;\r\n\r\n        if (data.total === coursesLength) {\r\n            Utils.disableButton(root);\r\n        } else if (root.find('.see_more').hasClass('hidden') && data.total > coursesLength) {\r\n            Utils.activeButton(root);\r\n        }\r\n        await issueCertificate(root);\r\n    } catch (error) {\r\n        root.find('.users-content').empty();\r\n        root.find('.total-users').text(0);\r\n        const html = await Templates.render(usersComponents.empty, {});\r\n        Utils.disableButton(root);\r\n        root.find('.users-content').append(html);\r\n    }\r\n\r\n}\r\n\r\nconst issueCertificate = async root => {\r\n    root.find('.btn-certificate').off();\r\n    root.find('.btn-certificate').on('click', async clickEvent => {\r\n\r\n        const hasCertificate = $(clickEvent.currentTarget).attr('data-hascertificate');\r\n        if(hasCertificate === 'true') {\r\n            regenCertificate(root, clickEvent);\r\n            return;\r\n        }\r\n        const response = await Repository.retrieveTemplates();\r\n        const userId = $(clickEvent.currentTarget).attr('data-userid');\r\n        const userFullName = $(clickEvent.currentTarget).attr('data-username');\r\n\r\n        const modal = await ModalDefault.create({\r\n            title: await getString('modal_issue_certificate_title', 'local_certificate_management'),\r\n            body: Templates.render('local_certificate_management/components/modal/select_certificate', {templates: response.templates}),\r\n            isVerticallyCentered: true,\r\n        });\r\n\r\n        modal.setFooter(await Templates.render('local_certificate_management/components/modal/modal_footer_issue', {}));\r\n        modal.getRoot().find('.btn.issue').on('click', async event => {\r\n            const selectValue = modal.getRoot().find('.chose-template').val();\r\n            const params = await getParams(root);\r\n\r\n            await issueCertificateCall(selectValue, params, userId, userFullName, modal);\r\n        });\r\n\r\n        await modal.show();\r\n    });\r\n}\r\n\r\nconst regenCertificate = async (root, event) => {\r\n    const response = await Repository.retrieveTemplates();\r\n    const userId = $(event.currentTarget).attr('data-userid');\r\n    const userFullName = $(event.currentTarget).attr('data-username');\r\n    const modal = await ModalDefault.create({\r\n        title: await getString('modal_regen_certificate', 'local_certificate_management'),\r\n        body: Templates.render('local_certificate_management/components/modal/regen_certificate', {templates: response.templates}),\r\n        isVerticallyCentered: true,\r\n    });\r\n\r\n    modal.setFooter(await Templates.render('local_certificate_management/components/modal/modal_footer_regen', {}));\r\n\r\n    modal.getRoot().find('.btn.regen').on('click', async event => {\r\n        const selectValue = modal.getRoot().find('.chose-template').val();\r\n\r\n        const params = await getParams(root);\r\n\r\n\r\n        await issueCertificateCall(selectValue, params, userId, userFullName, modal);\r\n    });\r\n\r\n    modal.getRoot().find('.btn.see').on('click', async event => {\r\n        const params = await getParams(root);\r\n\r\n        Repository.getCertificateUrl({\r\n            courseId: Number(params.courseId),\r\n            userId: Number(userId),\r\n        }).then(async (response) => {\r\n            window.open(response.certificate, \"_blank\");\r\n        }).catch(async () => {\r\n            modal.hide();\r\n            await ModalDefault.create({\r\n                title: await getString('modal_certified_issued_with_error_title', 'local_certificate_management'),\r\n                body: await getString('modal_certified_issued_not_found_body', 'local_certificate_management'),\r\n                show: true,\r\n                isVerticallyCentered: true\r\n            });\r\n        });\r\n    });\r\n\r\n    await modal.show();\r\n}\r\n\r\nconst issueCertificateCall = async (selectValue, params, userId, userFullName, modal) => {\r\n    if(!await validateSelectValue(selectValue)) {\r\n        return;\r\n    }\r\n\r\n    Repository.issueCertificate({\r\n        templateId: Number(selectValue),\r\n        courseId: Number(params.courseId),\r\n        userId: Number(userId),\r\n    }).then(async (response) => {\r\n        console.log(response);\r\n        modal.destroy();\r\n        await ModalDefault.create({\r\n            title: await getString('modal_certified_issued_with_success_title', 'local_certificate_management'),\r\n            body: await getString('modal_certified_issued_with_success_body', 'local_certificate_management', {\r\n                certificate: response.certificate,\r\n                name: userFullName\r\n            }),\r\n            show: true,\r\n            isVerticallyCentered: true\r\n        });\r\n    }).catch(async () => {\r\n        modal.destroy();\r\n        await ModalDefault.create({\r\n            title: await getString('modal_certified_issued_with_error_title', 'local_certificate_management'),\r\n            body: await getString('modal_certified_issued_with_error_body', 'local_certificate_management', userFullName),\r\n            show: true,\r\n            isVerticallyCentered: true\r\n        });\r\n    });\r\n}\r\n\r\nconst validateSelectValue = async (selectValue) => {\r\n    if(selectValue) {\r\n        return true;\r\n    }\r\n    await ModalDefault.create({\r\n        title: await getString('modal_certified_issued_with_error_title', 'local_certificate_management'),\r\n        body: await getString('modal_certified_issued_with_error_body_select', 'local_certificate_management'),\r\n        show: true,\r\n        isVerticallyCentered: true\r\n    });\r\n\r\n    return false;\r\n}\r\n\r\nconst init = async root => {\r\n    await loadUsers(root);\r\n\r\n    let timeout;\r\n    root.find('#search-param').on('keyup', e => {\r\n\r\n        clearTimeout(timeout);\r\n\r\n        timeout = setTimeout(async () => {\r\n            await loadUsers(root);\r\n        }, 2000);\r\n    });\r\n\r\n    root.find('#order-param').on('change', async event => {\r\n        await loadUsers(root);\r\n    });\r\n\r\n    root.find('.see_more').on('click', async function () {\r\n        const newPage = Number(root.attr('data-page')) + 1;\r\n        root.attr('data-page', newPage);\r\n        await loadUsers(root, true);\r\n    });\r\n}\r\n\r\nexport default {\r\n    init\r\n};"],"names":["getParams","async","courseId","Number","root","attr","limit","page","search","find","val","sort","usersComponents","loadUsers","seeMore","params","data","Repository","retrieveUsers","templateToLoad","users","length","disableButton","empty","text","html","Templates","render","total","append","coursesLength","hasClass","activeButton","issueCertificate","error","off","on","clickEvent","currentTarget","regenCertificate","response","retrieveTemplates","userId","userFullName","modal","ModalDefault","create","title","body","templates","isVerticallyCentered","setFooter","getRoot","selectValue","issueCertificateCall","show","event","getCertificateUrl","then","window","open","certificate","catch","hide","validateSelectValue","templateId","console","log","destroy","name","init","timeout","e","clearTimeout","setTimeout","newPage"],"mappings":"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"}