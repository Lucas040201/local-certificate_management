{"version":3,"file":"users.min.js","sources":["../src/users.js"],"sourcesContent":["import $ from 'jquery';\r\nimport Templates from \"core/templates\";\r\nimport ModalDefault from 'core/modal';\r\nimport ModalEvents from 'core/modal_events';\r\nimport {get_string as getString} from 'core/str';\r\nimport ModalSaveCancel from 'core/modal_save_cancel';\r\nimport Utils from 'local_certificate_management/utils';\r\nimport Repository from 'local_certificate_management/repository';\r\n\r\n\r\nconst getParams = async root => {\r\n    return {\r\n        courseId: Number(root.attr('data-courseid')),\r\n        limit: Number(root.attr('data-limit')),\r\n        page: Number(root.attr('data-page')),\r\n        search: root.find('#search-param').val() || '',\r\n        sort: root.find('#order-param').val() || '',\r\n    };\r\n}\r\n\r\nconst usersComponents = {\r\n    notFound: 'local_certificate_management/components/users/table-row-not-found',\r\n    empty: 'local_certificate_management/components/users/table-row-empty',\r\n    content: 'local_certificate_management/components/users/table-row'\r\n}\r\n\r\nconst loadUsers = async (root, seeMore = false) => {\r\n    try {\r\n        const params = await getParams(root);\r\n        const data = await Repository.retrieveUsers(params);\r\n\r\n        let templateToLoad = usersComponents.content;\r\n\r\n        if (!seeMore && !data.users.length && !params.search) {\r\n            templateToLoad = usersComponents.empty;\r\n        }\r\n\r\n        if (!seeMore && !data.users.length && params.search) {\r\n            Utils.disableButton(root);\r\n            templateToLoad = usersComponents.notFound;\r\n        }\r\n\r\n        if (!seeMore) {\r\n            root.find('.users-content').empty();\r\n            root.find('.total-users').text(0);\r\n        }\r\n\r\n        const html = await Templates.render(templateToLoad, {users: data.users});\r\n\r\n        root.find('.total-users').text(data.total)\r\n\r\n        root.find('.users-content').append(html);\r\n\r\n        const coursesLength = root.find('.users-item').length;\r\n\r\n        if (data.total === coursesLength) {\r\n            Utils.disableButton(root);\r\n        } else if (root.find('.see_more').hasClass('hidden') && data.total > coursesLength) {\r\n            Utils.activeButton(root);\r\n        }\r\n        await issueCertificate(root);\r\n    } catch (error) {\r\n        console.log(error);\r\n        root.find('.users-content').empty();\r\n        root.find('.total-users').text(0);\r\n        const html = await Templates.render(usersComponents.empty, {});\r\n        Utils.disableButton(root);\r\n        root.find('.users-content').append(html);\r\n    }\r\n\r\n}\r\n\r\nconst issueCertificate = async root => {\r\n    root.find('.btn-certificate').off();\r\n    root.find('.btn-certificate').on('click', async clickEvent => {\r\n        const response = await Repository.retrieveTemplates();\r\n        const userId = $(clickEvent.currentTarget).attr('data-userid');\r\n        const userFullName = $(clickEvent.currentTarget).attr('data-username');\r\n        const modal = await ModalSaveCancel.create({\r\n            title: await getString('modal_issue_certificate_title', 'local_certificate_management'),\r\n            body: Templates.render('local_certificate_management/components/modal/select_certificate', {templates: response.templates}),\r\n            isVerticallyCentered: true,\r\n        });\r\n\r\n        modal.getRoot().on(ModalEvents.save, async saveEvent => {\r\n            const selectValue = $(saveEvent.currentTarget).find('.chose-template').val();\r\n            const params = await getParams(root);\r\n\r\n            Repository.issueCertificate({\r\n                templateId: Number(selectValue),\r\n                courseId: Number(params.courseId),\r\n                userId: Number(userId),\r\n            }).then(async () => {\r\n                await ModalDefault.create({\r\n                    title: await getString('modal_certified_issued_with_success_title', 'local_certificate_management'),\r\n                    body: await getString('modal_certified_issued_with_success_body', 'local_certificate_management', userFullName),\r\n                    show: true,\r\n                    isVerticallyCentered: true\r\n                });\r\n            }).catch(async () => {\r\n                await ModalDefault.create({\r\n                    title: await getString('modal_certified_issued_with_error_title', 'local_certificate_management'),\r\n                    body: await getString('modal_certified_issued_with_error_body', 'local_certificate_management', userFullName),\r\n                    show: true,\r\n                    isVerticallyCentered: true\r\n                });\r\n            });\r\n        });\r\n\r\n        await modal.show();\r\n    });\r\n}\r\nconst init = async root => {\r\n    await loadUsers(root);\r\n\r\n    let timeout;\r\n    root.find('#search-param').on('keyup', e => {\r\n\r\n        clearTimeout(timeout);\r\n\r\n        timeout = setTimeout(async () => {\r\n            await loadUsers(root);\r\n        }, 2000);\r\n    });\r\n\r\n    root.find('#order-param').on('change', async event => {\r\n        await loadUsers(root);\r\n    });\r\n\r\n    root.find('.see_more').on('click', async function () {\r\n        const newPage = Number(root.attr('data-page')) + 1;\r\n        root.attr('data-page', newPage);\r\n        await loadUsers(root, true);\r\n    });\r\n}\r\n\r\nexport default {\r\n    init\r\n};"],"names":["getParams","async","courseId","Number","root","attr","limit","page","search","find","val","sort","usersComponents","loadUsers","seeMore","params","data","Repository","retrieveUsers","templateToLoad","users","length","disableButton","empty","text","html","Templates","render","total","append","coursesLength","hasClass","activeButton","issueCertificate","error","console","log","off","on","response","retrieveTemplates","userId","clickEvent","currentTarget","userFullName","modal","ModalSaveCancel","create","title","body","templates","isVerticallyCentered","getRoot","ModalEvents","save","selectValue","saveEvent","templateId","then","ModalDefault","show","catch","init","timeout","e","clearTimeout","setTimeout","newPage"],"mappings":"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"}