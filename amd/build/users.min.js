define("local_certificate_management/users",["exports","jquery","core/templates","core/modal","core/modal_events","core/str","core/modal_save_cancel","local_certificate_management/utils","local_certificate_management/repository"],(function(_exports,_jquery,_templates,_modal,_modal_events,_str,_modal_save_cancel,_utils,_repository){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_templates=_interopRequireDefault(_templates),_modal=_interopRequireDefault(_modal),_modal_events=_interopRequireDefault(_modal_events),_modal_save_cancel=_interopRequireDefault(_modal_save_cancel),_utils=_interopRequireDefault(_utils),_repository=_interopRequireDefault(_repository);const getParams=async root=>({courseId:Number(root.attr("data-courseid")),limit:Number(root.attr("data-limit")),page:Number(root.attr("data-page")),search:root.find("#search-param").val()||"",sort:root.find("#order-param").val()||""}),usersComponents_notFound="local_certificate_management/components/users/table-row-not-found",usersComponents_empty="local_certificate_management/components/users/table-row-empty",usersComponents_content="local_certificate_management/components/users/table-row",loadUsers=async function(root){let seeMore=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{const params=await getParams(root),data=await _repository.default.retrieveUsers(params);let templateToLoad=usersComponents_content;seeMore||data.users.length||params.search||(templateToLoad=usersComponents_empty),seeMore||data.users.length||!params.search||(_utils.default.disableButton(root),templateToLoad=usersComponents_notFound),seeMore||(root.find(".users-content").empty(),root.find(".total-users").text(0));const html=await _templates.default.render(templateToLoad,{users:data.users});root.find(".total-users").text(data.total),root.find(".users-content").append(html);const coursesLength=root.find(".users-item").length;data.total===coursesLength?_utils.default.disableButton(root):root.find(".see_more").hasClass("hidden")&&data.total>coursesLength&&_utils.default.activeButton(root),await issueCertificate(root),await issueHistory(root)}catch(error){root.find(".users-content").empty(),root.find(".total-users").text(0);const html=await _templates.default.render(usersComponents_empty,{});_utils.default.disableButton(root),root.find(".users-content").append(html)}},issueHistory=async root=>{root.find(".btn-history").off(),root.find(".btn-history").on("click",(async clickEvent=>{if("true"===(0,_jquery.default)(clickEvent.currentTarget).attr("data-hashistory"))return void regenHistory(root,clickEvent);const userId=(0,_jquery.default)(clickEvent.currentTarget).attr("data-userid"),userFullName=(0,_jquery.default)(clickEvent.currentTarget).attr("data-username"),modal=await _modal.default.create({title:await(0,_str.get_string)("modal_issue_history_title","local_certificate_management"),body:await(0,_str.get_string)("generate_history","local_certificate_management",userFullName),isVerticallyCentered:!0});modal.setFooter(await _templates.default.render("local_certificate_management/components/modal/modal_footer_gen_history",{})),modal.getRoot().find(".btn.issue").on("click",(async event=>{const params=await getParams(root);await issueHistoryCall(params,userId,userFullName,modal,root)})),await modal.show()}))},regenHistory=async(root,event)=>{const userId=(0,_jquery.default)(event.currentTarget).attr("data-userid"),userFullName=(0,_jquery.default)(event.currentTarget).attr("data-username"),modal=await _modal.default.create({title:await(0,_str.get_string)("modal_regen_history","local_certificate_management"),body:await(0,_str.get_string)("regen_history","local_certificate_management"),isVerticallyCentered:!0});modal.setFooter(await _templates.default.render("local_certificate_management/components/modal/modal_footer_regen_history",{})),modal.getRoot().find(".btn.regen").off(),modal.getRoot().find(".btn.regen").on("click",(async event=>{const params=await getParams(root);await issueHistoryCall(params,userId,userFullName,modal,root)})),modal.getRoot().find(".btn.see").off(),modal.getRoot().find(".btn.see").on("click",(async event=>{const params=await getParams(root);_repository.default.getHistoryUrl({courseId:Number(params.courseId),userId:Number(userId)}).then((async response=>{window.open(response.history,"_blank")})).catch((async()=>{modal.hide(),await _modal.default.create({title:await(0,_str.get_string)("modal_certified_issued_with_error_title","local_certificate_management"),body:await(0,_str.get_string)("modal_certified_issued_not_found_body","local_certificate_management"),show:!0,isVerticallyCentered:!0})}))})),await modal.show()},issueHistoryCall=async(params,userId,userFullName,modal,root)=>{_repository.default.issueHistory({courseId:Number(params.courseId),userId:Number(userId)}).then((async response=>{modal.destroy(),await _modal.default.create({title:await(0,_str.get_string)("modal_history_issued_with_success_title","local_certificate_management"),body:await(0,_str.get_string)("modal_history_issued_with_success_body","local_certificate_management",{history:response.history,name:userFullName}),show:!0,isVerticallyCentered:!0}),await resetAndReload(root)})).catch((async error=>{modal.destroy(),await _modal.default.create({title:await(0,_str.get_string)("modal_history_issued_with_error_title","local_certificate_management"),body:await(0,_str.get_string)("modal_history_issued_with_error_body","local_certificate_management",userFullName),show:!0,isVerticallyCentered:!0})}))},issueCertificate=async root=>{root.find(".btn-certificate").off(),root.find(".btn-certificate").on("click",(async clickEvent=>{if("true"===(0,_jquery.default)(clickEvent.currentTarget).attr("data-hascertificate"))return void regenCertificate(root,clickEvent);const response=await _repository.default.retrieveTemplates(),userId=(0,_jquery.default)(clickEvent.currentTarget).attr("data-userid"),userFullName=(0,_jquery.default)(clickEvent.currentTarget).attr("data-username"),modal=await _modal.default.create({title:await(0,_str.get_string)("modal_issue_certificate_title","local_certificate_management"),body:_templates.default.render("local_certificate_management/components/modal/select_certificate",{templates:response.templates}),isVerticallyCentered:!0});modal.setFooter(await _templates.default.render("local_certificate_management/components/modal/modal_footer_issue",{})),modal.getRoot().find(".btn.issue").off(),modal.getRoot().find(".btn.issue").on("click",(async event=>{const selectValue=modal.getRoot().find(".chose-template").val(),params=await getParams(root);await issueCertificateCall(selectValue,params,userId,userFullName,modal,root)})),await modal.show()}))},regenCertificate=async(root,event)=>{const response=await _repository.default.retrieveTemplates(),userId=(0,_jquery.default)(event.currentTarget).attr("data-userid"),userFullName=(0,_jquery.default)(event.currentTarget).attr("data-username"),modal=await _modal.default.create({title:await(0,_str.get_string)("modal_regen_certificate","local_certificate_management"),body:_templates.default.render("local_certificate_management/components/modal/regen_certificate",{templates:response.templates}),isVerticallyCentered:!0});modal.setFooter(await _templates.default.render("local_certificate_management/components/modal/modal_footer_regen",{})),modal.getRoot().find(".btn.regen").off(),modal.getRoot().find(".btn.regen").on("click",(async event=>{const selectValue=modal.getRoot().find(".chose-template").val(),params=await getParams(root);await issueCertificateCall(selectValue,params,userId,userFullName,modal,root)})),modal.getRoot().find(".btn.see").off(),modal.getRoot().find(".btn.see").on("click",(async event=>{const params=await getParams(root);_repository.default.getCertificateUrl({courseId:Number(params.courseId),userId:Number(userId)}).then((async response=>{window.open(response.certificate,"_blank")})).catch((async()=>{modal.hide(),await _modal.default.create({title:await(0,_str.get_string)("modal_certified_issued_with_error_title","local_certificate_management"),body:await(0,_str.get_string)("modal_certified_issued_not_found_body","local_certificate_management"),show:!0,isVerticallyCentered:!0})}))})),await modal.show()},issueCertificateCall=async(selectValue,params,userId,userFullName,modal,root)=>{await validateSelectValue(selectValue)&&_repository.default.issueCertificate({templateId:Number(selectValue),courseId:Number(params.courseId),userId:Number(userId)}).then((async response=>{console.log(response),modal.destroy(),await _modal.default.create({title:await(0,_str.get_string)("modal_certified_issued_with_success_title","local_certificate_management"),body:await(0,_str.get_string)("modal_certified_issued_with_success_body","local_certificate_management",{certificate:response.certificate,name:userFullName}),show:!0,isVerticallyCentered:!0}),await resetAndReload(root)})).catch((async()=>{modal.destroy(),await _modal.default.create({title:await(0,_str.get_string)("modal_certified_issued_with_error_title","local_certificate_management"),body:await(0,_str.get_string)("modal_certified_issued_with_error_body","local_certificate_management",userFullName),show:!0,isVerticallyCentered:!0})}))},validateSelectValue=async selectValue=>!!selectValue||(await _modal.default.create({title:await(0,_str.get_string)("modal_certified_issued_with_error_title","local_certificate_management"),body:await(0,_str.get_string)("modal_certified_issued_with_error_body_select","local_certificate_management"),show:!0,isVerticallyCentered:!0}),!1),resetAndReload=async root=>{root.attr("data-page",1),await loadUsers(root)};var _default={init:async root=>{let timeout;await loadUsers(root),root.find("#search-param").on("keyup",(e=>{clearTimeout(timeout),timeout=setTimeout((async()=>{await loadUsers(root)}),2e3)})),root.find("#order-param").on("change",(async event=>{await loadUsers(root)})),root.find(".see_more").on("click",(async function(){const newPage=Number(root.attr("data-page"))+1;root.attr("data-page",newPage),await loadUsers(root,!0)}))}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=users.min.js.map